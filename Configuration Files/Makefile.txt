# Makefile - TapsiFood Dashboard Deployment Automation

.PHONY: help install dev-install build test deploy deploy-prod clean logs status backup restore

# Default target
help: ## Show this help message
	@echo "TapsiFood Dashboard - Production Deployment"
	@echo "=========================================="
	@echo ""
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Environment setup
install: ## Install production dependencies
	@echo "ðŸ”§ Installing production dependencies..."
	pip install -r production_requirements.txt
	@echo "âœ… Dependencies installed"

dev-install: ## Install development dependencies
	@echo "ðŸ”§ Installing development dependencies..."
	pip install -r requirements.txt
	pip install -r production_requirements.txt
	@echo "âœ… Development environment ready"

# Database operations
init-db: ## Initialize database with tables and data
	@echo "ðŸ—„ï¸ Initializing database..."
	python scripts/init_db.py --full-setup
	@echo "âœ… Database initialized"

migrate-db: ## Migrate data from old system
	@echo "ðŸ”„ Migrating data..."
	python scripts/init_db.py --migrate-data --force-refresh
	@echo "âœ… Data migration completed"

verify-db: ## Verify database installation
	@echo "ðŸ” Verifying database..."
	python scripts/init_db.py --verify
	@echo "âœ… Database verification completed"

# Docker operations
build: ## Build Docker images
	@echo "ðŸ³ Building Docker images..."
	docker-compose -f docker-compose.prod.yml build
	@echo "âœ… Docker images built"

build-no-cache: ## Build Docker images without cache
	@echo "ðŸ³ Building Docker images (no cache)..."
	docker-compose -f docker-compose.prod.yml build --no-cache
	@echo "âœ… Docker images built"

# Development deployment
dev: ## Start development environment
	@echo "ðŸš€ Starting development environment..."
	docker-compose up -d postgres redis
	@sleep 10
	python backend/api.py
	@echo "âœ… Development environment started"

dev-down: ## Stop development environment
	@echo "ðŸ›‘ Stopping development environment..."
	docker-compose down
	@echo "âœ… Development environment stopped"

# Production deployment
deploy: ## Deploy to production (single server)
	@echo "ðŸš€ Deploying to production..."
	@make build
	@make deploy-services
	@make init-db
	@make health-check
	@echo "âœ… Production deployment completed"

deploy-services: ## Deploy services only
	@echo "ðŸš€ Deploying services..."
	docker-compose -f docker-compose.prod.yml up -d
	@echo "â³ Waiting for services to start..."
	@sleep 30
	@echo "âœ… Services deployed"

deploy-prod: ## Deploy with production profile including monitoring
	@echo "ðŸš€ Deploying with monitoring..."
	docker-compose -f docker-compose.prod.yml --profile monitoring up -d
	@echo "âœ… Production deployment with monitoring completed"

scale: ## Scale web services (use with REPLICAS=n)
	@echo "ðŸ“ˆ Scaling web services to $(REPLICAS) replicas..."
	docker-compose -f docker-compose.prod.yml up -d --scale web=$(REPLICAS)
	@echo "âœ… Scaling completed"

# Service management
start: ## Start all services
	@echo "â–¶ï¸ Starting services..."
	docker-compose -f docker-compose.prod.yml start
	@echo "âœ… Services started"

stop: ## Stop all services
	@echo "â¹ï¸ Stopping services..."
	docker-compose -f docker-compose.prod.yml stop
	@echo "âœ… Services stopped"

restart: ## Restart all services
	@echo "ðŸ”„ Restarting services..."
	docker-compose -f docker-compose.prod.yml restart
	@echo "âœ… Services restarted"

restart-web: ## Restart web services only
	@echo "ðŸ”„ Restarting web services..."
	docker-compose -f docker-compose.prod.yml restart web nginx
	@echo "âœ… Web services restarted"

restart-workers: ## Restart worker services only
	@echo "ðŸ”„ Restarting worker services..."
	docker-compose -f docker-compose.prod.yml restart worker scheduler
	@echo "âœ… Worker services restarted"

# Health and monitoring
health-check: ## Check system health
	@echo "ðŸ¥ Checking system health..."
	@sleep 10
	@curl -f http://localhost/api/v2/health || (echo "âŒ Health check failed" && exit 1)
	@echo "âœ… System healthy"

status: ## Show service status
	@echo "ðŸ“Š Service Status:"
	@docker-compose -f docker-compose.prod.yml ps
	@echo ""
	@echo "ðŸ¥ Health Status:"
	@curl -s http://localhost/api/v2/health | python -m json.tool || echo "âŒ API not responding"

logs: ## Show service logs
	@echo "ðŸ“‹ Service Logs:"
	docker-compose -f docker-compose.prod.yml logs --tail=100 -f

logs-web: ## Show web service logs
	@echo "ðŸ“‹ Web Service Logs:"
	docker-compose -f docker-compose.prod.yml logs --tail=100 -f web nginx

logs-worker: ## Show worker service logs
	@echo "ðŸ“‹ Worker Service Logs:"
	docker-compose -f docker-compose.prod.yml logs --tail=100 -f worker scheduler

logs-db: ## Show database logs
	@echo "ðŸ“‹ Database Logs:"
	docker-compose -f docker-compose.prod.yml logs --tail=100 -f postgres

# Data operations
backup: ## Backup database
	@echo "ðŸ’¾ Creating database backup..."
	@mkdir -p backups
	@docker-compose -f docker-compose.prod.yml exec postgres pg_dump -U dashboard_user tapsifood_dashboard > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Database backed up to backups/"

restore: ## Restore database from backup (use with BACKUP_FILE=filename)
	@echo "ðŸ”„ Restoring database from $(BACKUP_FILE)..."
	@docker-compose -f docker-compose.prod.yml exec -T postgres psql -U dashboard_user tapsifood_dashboard < $(BACKUP_FILE)
	@echo "âœ… Database restored"

export-data: ## Export current data to CSV
	@echo "ðŸ“¤ Exporting data..."
	python scripts/export_data.py
	@echo "âœ… Data exported to exports/"

# Cache operations
clear-cache: ## Clear Redis cache
	@echo "ðŸ§¹ Clearing cache..."
	docker-compose -f docker-compose.prod.yml exec redis redis-cli FLUSHALL
	@echo "âœ… Cache cleared"

warm-cache: ## Warm up cache
	@echo "ðŸ”¥ Warming cache..."
	curl -X POST http://localhost/api/v2/admin/warm-cache
	@echo "âœ… Cache warmed"

# Maintenance
refresh-data: ## Trigger manual data refresh
	@echo "ðŸ”„ Triggering data refresh..."
	curl -X POST http://localhost/api/v2/admin/refresh-data
	@echo "âœ… Data refresh triggered"

clean: ## Clean up Docker resources
	@echo "ðŸ§¹ Cleaning up..."
	docker-compose -f docker-compose.prod.yml down --volumes --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup completed"

clean-all: ## Clean up everything including images
	@echo "ðŸ§¹ Deep cleaning..."
	docker-compose -f docker-compose.prod.yml down --volumes --remove-orphans --rmi all
	docker system prune -af
	@echo "âœ… Deep cleanup completed"

# Testing
test: ## Run tests
	@echo "ðŸ§ª Running tests..."
	pytest tests/ -v --cov=backend
	@echo "âœ… Tests completed"

test-api: ## Test API endpoints
	@echo "ðŸ§ª Testing API endpoints..."
	python scripts/test_api.py
	@echo "âœ… API tests completed"

# Security
security-scan: ## Run security scan
	@echo "ðŸ”’ Running security scan..."
	docker run --rm -v $(PWD):/src sonarqube/sonar-scanner-cli
	@echo "âœ… Security scan completed"

# Performance
benchmark: ## Run performance benchmark
	@echo "âš¡ Running performance benchmark..."
	python scripts/benchmark.py
	@echo "âœ… Benchmark completed"

load-test: ## Run load test
	@echo "ðŸ‹ï¸ Running load test..."
	locust -f scripts/load_test.py --host=http://localhost
	@echo "âœ… Load test completed"

# Monitoring
monitor: ## Start monitoring dashboard
	@echo "ðŸ“Š Starting monitoring..."
	@make deploy-prod
	@echo "ðŸŒ Grafana available at: http://localhost:3000"
	@echo "ðŸ“ˆ Prometheus available at: http://localhost:9090"

# SSL setup
setup-ssl: ## Setup SSL certificates
	@echo "ðŸ”’ Setting up SSL certificates..."
	./scripts/setup_ssl.sh
	@echo "âœ… SSL certificates configured"

# Production utilities
production-check: ## Pre-production checklist
	@echo "âœ… Pre-production Checklist:"
	@echo "ðŸ“‹ Checking environment variables..."
	@python scripts/check_env.py
	@echo "ðŸ“‹ Checking database connection..."
	@make verify-db
	@echo "ðŸ“‹ Checking Redis connection..."
	@docker-compose -f docker-compose.prod.yml exec redis redis-cli ping
	@echo "ðŸ“‹ Checking API health..."
	@make health-check
	@echo "âœ… All checks passed - ready for production!"

# Quick commands
quick-deploy: build deploy-services health-check ## Quick deployment without data migration
	@echo "âš¡ Quick deployment completed"

full-deploy: build deploy-services init-db health-check ## Full deployment with data migration
	@echo "ðŸŽ‰ Full deployment completed"

# Environment variables
.env:
	@echo "ðŸ“ Creating .env file from template..."
	@cp .env.example .env
	@echo "âš ï¸  Please edit .env file with your configuration"

# Help for common workflows
workflow-dev: ## Show development workflow
	@echo "ðŸ”§ Development Workflow:"
	@echo "1. make dev-install"
	@echo "2. make .env (edit configuration)"
	@echo "3. make dev"

workflow-prod: ## Show production workflow
	@echo "ðŸš€ Production Workflow:"
	@echo "1. make install"
	@echo "2. make .env (edit configuration)"
	@echo "3. make production-check"
	@echo "4. make full-deploy"
	@echo "5. make monitor"